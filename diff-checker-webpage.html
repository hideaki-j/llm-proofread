<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Proofreader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <script src="openai-api-key.js"></script>
    <script src="textManuplation.js"></script>
    <script src="prompt.js"></script>
    <style>
        /* Add this at the beginning of the style section */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f1f3f4;
            color: #202124;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .column {
            flex: 1 1 calc(33.333% - 20px);
            min-width: 250px;
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            padding: 15px;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            resize: vertical;
        }
        .diff-box {
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px;
            white-space: pre-wrap;
            height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
        .removed {
            background-color: #fce8e6;
            color: #d93025;
        }
        .added {
            background-color: #e6f4ea;
            color: #137333;
        }
        #apiKey {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
        }
        .copy-button {
            position: absolute;
            bottom: 25px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #5f6368;
            transition: color 0.3s ease;
        }
        .copy-button:hover {
            color: #1a73e8;
        }
        #copyAlert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #323232;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            display: none;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .options-column {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        #sameWordStart {
            width: 200px;
            margin-left: 10px;
            padding: 4px 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
        }
        #notes {
            background-color: #f8f9fa;
            border: 1px solid #dadce0;
            color: #202124;
            cursor: default;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            resize: none;
        }
        #notes:focus {
            outline: none;
        }
        #userNotes {
            height: 80px;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            transition-duration: 0.2s;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #174ea6;
        }
        #setApiKeyBtn {
            background-color: #fff;
            color: #1a73e8;
            border: 1px solid #dadce0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #setApiKeyBtn:hover {
            background-color: #f1f3f4;
        }
        h1, h2 {
            color: #202124;
            margin-bottom: 15px;
        }
        h1 {
            font-size: 24px;
            font-weight: normal;
        }
        h2 {
            font-size: 16px;
            font-weight: 500;
        }
        .full-width {
            flex-basis: 100%;
        }
        #text1 {
            height: 200px;
        }
        @media (max-width: 768px) {
            .column {
                flex-basis: 100%;
            }
        }
        .word-count {
            font-size: 12px;
            color: #5f6368;
            margin-top: 5px;
            text-align: right;
        }

        .popup {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .popup-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 900px;
            border-radius: 8px;
            position: relative;
            padding-top: 40px;
        }

        #comparisonContainer {
            margin-bottom: 20px;
        }

        .comparison-line {
            margin-bottom: 10px;
            font-size: 16px;
        }

        #comparisonButtons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        #comparisonProgress {
            text-align: center;
            font-size: 14px;
            color: #5f6368;
        }

        #pairwiseCompareBtn {
            background-color: #dadce0;
            color: #5f6368;
            opacity: 0.7;
            cursor: not-allowed;
        }

        #pairwiseCompareBtn.active {
            background-color: #1a73e8;
            color: white;
            opacity: 1;
            cursor: pointer;
        }

        #pairwiseCompareBtn.active:hover {
            background-color: #174ea6;
        }

        .comparison-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 20px;
        }
        .comparison-column {
            width: calc(50% - 10px);
        }
        .comparison-box {
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px;
            white-space: pre-wrap;
            height: 300px;
            overflow-y: auto;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .diff-highlight {
            background-color: #fff2cc;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #5f6368;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }
        .close-btn:hover {
            color: #1a73e8;
        }

        #resultContainer {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
        }

        #optionsContainer {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
        }

        #optionsContainer.show {
            max-height: 1000px;
            opacity: 1;
        }

        #apiKeyPopup {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        #apiKeyPopupContent {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 8px;
            position: relative;
        }

        #apiKeyPopupContent h2 {
            margin-top: 0;
        }

        #apiKeyPopupContent input {
            width: 100%;
            margin-bottom: 10px;
        }

        #apiKeyPopupContent button {
            width: 100%;
        }

        #apiKeyPopupContent .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #5f6368;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }
        #apiKeyPopupContent .close-btn:hover {
            color: #1a73e8;
        }

        /* Add this new popup div after the other popups */
        #spaceOnlyPopup {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        #spaceOnlyPopup .popup-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 8px;
            position: relative;
        }

        #spaceOnlyPopup .popup-content h2 {
            margin-top: 0;
        }

        #spaceOnlyCountdown {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        #spaceOnlyProgressBar {
            width: 100%;
            height: 5px;
            background-color: #e0e0e0;
            margin-bottom: 10px;
        }

        #spaceOnlyProgressBar::before {
            content: '';
            display: block;
            height: 100%;
            background-color: #1a73e8;
            width: 0;
            transition: width 3s linear;
        }

        #spaceOnlyPopup.active #spaceOnlyProgressBar::before {
            width: 100%;
        }

        #spaceOnlyPopup .popup-content .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #5f6368;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }
        #spaceOnlyPopup .popup-content .close-btn:hover {
            color: #1a73e8;
        }

        /* Add styles for the diff popup */
        .diff-popup {
            position: absolute;
            display: none;
            background-color: #fff;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .diff-popup button {
            display: inline-block;
            margin-top: 10px;
            margin-right: 10px;
            padding: 5px 10px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .diff-popup button:hover {
            background-color: #174ea6;
        }

        .diff-popup .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
            font-weight: bold;
            color: #5f6368;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .diff-hover {
            background-color: #fff2cc;
            cursor: pointer;
        }

        /* Add these new styles */
        #additions {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #additions:focus {
            outline: none;
            border: 1px solid #1a73e8;
        }
    </style>
</head>
<body>
    <h1>LLM Proofreader</h1>
    <button id="setApiKeyBtn" onclick="toggleApiKeyInput()">Set OpenAI API key</button>
    
    <!-- Add this new div for the API key popup -->
    <div id="apiKeyPopup">
        <div id="apiKeyPopupContent">
            <span class="close-btn" onclick="toggleApiKeyInput()">&times;</span>
            <h2>Set OpenAI API Key</h2>
            <input type="text" id="apiKey" placeholder="Enter your OpenAI API key">
            <button onclick="saveApiKey()">Save API Key</button>
        </div>
    </div>
    
    <!-- Add this new button -->
    <button id="toggleOptionsBtn" onclick="toggleOptions()">Show Options</button>
    
    <!-- Wrap the Context, Notes, and Options sections in a new container -->
    <div id="optionsContainer">
        <!-- First row: Context, Notes, and Options -->
        <div class="container">
            <div class="column">
                <h2>Context</h2>
                <textarea id="context" placeholder="Enter context here"></textarea>
            </div>
            <div class="column">
                <h2>Notes</h2>
                <textarea id="notes" placeholder="Notes will appear here" readonly></textarea>
            </div>
            <div class="column options-column">
                <h2>Options</h2>
                <div class="checkbox-container">
                    <input type="checkbox" id="keepLatexCheck" onchange="updateNotes()">
                    <label for="keepLatexCheck">Keep LaTeX commands as they are</label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="sameWordStartCheck" onchange="toggleSameWordStart()">
                    <label for="sameWordStartCheck">Specify starting words:</label>
                    <input type="text" id="sameWordStart" disabled onchange="updateNotes()">
                </div>
                <textarea id="userNotes" placeholder="Enter your additional notes here"></textarea>
            </div>
        </div>
    </div>

    <!-- Second row: Original text -->
    <div class="container">
        <div class="column full-width">
            <h2>Original</h2>
            <textarea id="text1" placeholder="Enter the original text here"></textarea>
        </div>
    </div>

    <button onclick="callGPTandCompareDiff()" id="proofreadBtn">Proofread</button>

    <!-- Third row: Original Diff and Rewritten Diff (unchanged) -->
    <div class="container">
        <div class="column">
            <h2>Original Diff</h2>
            <div id="removals" class="diff-box"></div>
            <div id="removalsWordCount" class="word-count"></div>
        </div>
        <div class="column">
            <h2>Rewritten Diff</h2>
            <div id="additions" class="diff-box" contenteditable="true"></div>
            <div id="additionsWordCount" class="word-count"></div>
            <button onclick="copyAdditions()" class="copy-button">ðŸ“‹</button>
        </div>
    </div>
    <div id="copyAlert">Text copied to clipboard!</div>

    <div id="resultPopup" class="popup">
        <div class="popup-content">
            <span class="close-btn" onclick="closeResultPopup()">&times;</span>
            <h2>Comparison Result</h2>
            <textarea id="resultContainer" readonly></textarea>
            <button onclick="copyResult()">Copy Result</button>
            <button onclick="replaceOriginal()">Replace Original</button>
            <button onclick="closeResultPopup()">Close</button>
        </div>
    </div>

    <!-- Add this new popup div after the other popups -->
    <div id="spaceOnlyPopup" class="popup">
        <div class="popup-content">
            <h2>Space-only Difference Detected</h2>
            <p>There's a difference in spacing or line breaks. The system will automatically use original spacing in:</p>
            <div id="spaceOnlyCountdown">3</div>
            <div id="spaceOnlyProgressBar"></div>
            <button onclick="cancelSpaceOnlySelection()">Cancel</button>
        </div>
    </div>

    <!-- Add this div for the diff popup -->
    <div id="diffPopup" class="diff-popup">
        <div id="diffPopupContent">
            <span class="close-btn" onclick="closeDiffPopup()">&times;</span>
            <div><strong>Original:</strong> <span id="diffOriginalText"></span></div>
            <div><strong>Rewritten:</strong> <span id="diffRewrittenText"></span></div>
            <button id="keepOriginalBtn">Keep Original</button>
            <button id="acceptChangeBtn">Accept Change</button>
        </div>
    </div>

    <script>
        // Add this at the beginning of the script section
        const dmp = new diff_match_patch();

        let globalDiffInfo = [];
        let originalPairwise = '';
        let rewrittenPairwise = '';
        let currentDiffInfo = [];
        let currentPairIndex = 0;
        let originalPairCount = 0; // Add this new variable
        let pairwiseProgress = 1; // Add this new variable
        let editTimer;

        function splitSentence(sentence) {
            return sentence.match(/\b[\w']+\b|\s+|[^\w\s]+/g) || [];
        }

        // Add this new wrapper function near the top of the script section
        function performDiff(text1, text2, isWordLevel = true) {
            if (!isWordLevel) {
                const diffs = dmp.diff_main(text1, text2);
                dmp.diff_cleanupSemantic(diffs);
                return diffs;
            } else {
                // Implement word-level diff
                const wordArray = [];
                const wordHash = {};
                wordArray[0] = '';

                // This function maps words to characters
                function diffWordsToCharsMunge_(text) {
                    let chars = '';
                    const words = splitSentence(text);
                    for (let i = 0; i < words.length; i++) {
                        const word = words[i];
                        if (wordHash.hasOwnProperty(word)) {
                            chars += String.fromCharCode(wordHash[word]);
                        } else {
                            chars += String.fromCharCode(wordArray.length);
                            wordHash[word] = wordArray.length;
                            wordArray.push(word);
                        }
                    }
                    return chars;
                }

                // Convert characters back to words
                function diff_charsToWords_(diffs) {
                    for (let i = 0; i < diffs.length; i++) {
                        const chars = diffs[i][1];
                        const text = [];
                        for (let j = 0; j < chars.length; j++) {
                            text.push(wordArray[chars.charCodeAt(j)]);
                        }
                        diffs[i][1] = text.join('');
                    }
                }
                
                // Convert text to characters
                const chars1 = diffWordsToCharsMunge_(text1);
                const chars2 = diffWordsToCharsMunge_(text2);

                const diffs = dmp.diff_main(chars1, chars2, false);
                dmp.diff_cleanupSemantic(diffs);

                // Convert characters back to words
                diff_charsToWords_(diffs);

                return diffs;
            }
        }

        function toggleSameWordStart() {
            const checkbox = document.getElementById('sameWordStartCheck');
            const input = document.getElementById('sameWordStart');
            const originalText = document.getElementById('text1').value;

            if (checkbox.checked) {
                input.disabled = false;
                const firstWord = originalText.trim().split(/\s+/)[0] || '';
                input.value = firstWord;
            } else {
                input.disabled = true;
                input.value = '';
            }
            updateNotes();
        }

        function updateNotes() {
            const keepLatexCheck = document.getElementById('keepLatexCheck');
            const sameWordStartCheck = document.getElementById('sameWordStartCheck');
            const sameWordStart = document.getElementById('sameWordStart').value;
            const userNotes = document.getElementById('userNotes').value;

            let optionsNotes = '';
            if (keepLatexCheck.checked) {
                optionsNotes += "- Keep LaTeX commands (e.g., textit, textbf, etc) as they are.\n";
            }
            if (sameWordStartCheck.checked && sameWordStart) {
                optionsNotes += `- Rewritten sentence must start with the words: \"${sameWordStart}\"\n`;
            }

            const fullNotes = optionsNotes + userNotes;
            document.getElementById('notes').value = fullNotes;
        }

        async function callChatGPT(text, context) {
            const apiKeyInput = document.getElementById('apiKey');
            const apiKey = apiKeyInput.value.trim() || OPENAI_API_KEY;
            const notes = document.getElementById('notes').value;

            const prompt = CHATGPT_PROMPT
                .replace('{{notes}}', notes)
                .replace('{{context}}', context)
                .replace('{{text}}', text);

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.6,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error("Error calling ChatGPT API:", error);
                return "Error: Unable to generate rewritten text.";
            }
        }

        function getWordCount(text) {
            return text.trim().split(/\s+/).length;
        }

        function getDiffInfo(diffs) {
            let diffInfo = [];
            let originalIndex = 0;
            let rewrittenIndex = 0;

            for (let i = 0; i < diffs.length; i++) {
                const [type, text] = diffs[i];
                // type: -1: removed, 0: unchanged, 1: added

                let originalTextLength = 0;
                let rewrittenTextLength = 0;

                if (type === -1) {
                    originalTextLength = text.length;
                } else if (type === 1) {
                    rewrittenTextLength = text.length;
                } else {
                    originalTextLength = text.length;
                    rewrittenTextLength = text.length;
                }

                if (type === -1 || type === 1) {
                    let info = {
                        originalSpanStart: originalIndex,
                        originalSpanEnd: originalIndex + originalTextLength,
                        rewrittenSpanStart: rewrittenIndex,
                        rewrittenSpanEnd: rewrittenIndex + rewrittenTextLength,
                        originalDiffString: type === -1 ? text : '',
                        rewrittenDiffString: type === 1 ? text : ''
                    };

                    // Check if the next diff is the opposite type (forming a pair)
                    if (i + 1 < diffs.length && diffs[i + 1][0] === -type) {
                        const [nextType, nextText] = diffs[i + 1];

                        if (type === -1) {
                            // Current is deletion, next is addition
                            info.rewrittenSpanEnd = rewrittenIndex + nextText.length;
                            info.rewrittenDiffString = nextText;
                            rewrittenTextLength += nextText.length;
                        } else {
                            // Current is addition, next is deletion
                            info.originalSpanEnd = originalIndex + nextText.length;
                            info.originalDiffString = nextText;
                            originalTextLength += nextText.length;
                        }
                        i++; // Skip the next diff since we've processed it
                    }

                    diffInfo.push(info);
                }

                originalIndex += originalTextLength;
                rewrittenIndex += rewrittenTextLength;
            }
            console.log('diffInfo', diffInfo);
            return diffInfo;
        }

        // Update the existing updateDiffView function
        function updateDiffView(originalText, rewrittenText) {
            originalPairwise = originalText;
            rewrittenPairwise = rewrittenText;

            console.log('updateDiffView', originalText, rewrittenText); 
            const diffs = performDiff(originalText, rewrittenText);
            globalDiffInfo = getDiffInfo(diffs);
            let removalsHtml = '';
            let additionsHtml = '';
            let diffInfoIndex = 0;

            for (let i = 0; i < diffs.length; i++) {
                const [type, text] = diffs[i];
                if (type === 0) {
                    removalsHtml += escapeHtml(text);
                    additionsHtml += escapeHtml(text);
                    continue;
                }

                const isPair = i + 1 < diffs.length && diffs[i + 1][0] === -type;
                const htmlSegment = `<span class="${type === -1 ? 'removed' : 'added'}" data-diff-index="${diffInfoIndex}">${escapeHtml(text)}</span>`;

                if (type === -1) removalsHtml += htmlSegment;
                else additionsHtml += htmlSegment;

                if (isPair) {
                    const [nextType, nextText] = diffs[++i];
                    const nextHtmlSegment = `<span class="${nextType === -1 ? 'removed' : 'added'}" data-diff-index="${diffInfoIndex}">${escapeHtml(nextText)}</span>`;
                    if (nextType === -1) removalsHtml += nextHtmlSegment;
                    else additionsHtml += nextHtmlSegment;
                }

                diffInfoIndex++;
            }

            document.getElementById('removals').innerHTML = removalsHtml || 'No changes';
            document.getElementById('additions').innerHTML = additionsHtml || 'No changes';

            // Calculate and display word counts
            const removalsWordCount = getWordCount(originalText);
            const additionsWordCount = getWordCount(rewrittenText);
            document.getElementById('removalsWordCount').textContent = `Word count: ${removalsWordCount}`;
            document.getElementById('additionsWordCount').textContent = `Word count: ${additionsWordCount}`;

            // Add event listeners to the diff spans
            addDiffEventListeners();

            // Add event listener for edits in the rewritten diff
            document.getElementById('additions').addEventListener('input', handleRewrittenEdit);
        }

        // Add this new function to handle edits in the rewritten diff
        function handleRewrittenEdit() {
            clearTimeout(editTimer);
            editTimer = setTimeout(() => {
                const newRewrittenText = document.getElementById('additions').innerText;
                updateDiffView(originalPairwise, newRewrittenText);
            }, 3000);
        }

        // Function to add event listeners to the diff spans
        function addDiffEventListeners() {
            const diffSpans = document.querySelectorAll('#removals .removed[data-diff-index], #additions .added[data-diff-index]');

            diffSpans.forEach(span => {
                span.addEventListener('mouseover', handleDiffHover);
                span.addEventListener('mouseout', handleDiffMouseOut);
                span.addEventListener('click', handleDiffClick);
            });
        }

        // Handle hover event on diff spans
        function handleDiffHover(event) {
            const span = event.target;
            span.classList.add('diff-hover');
        }

        // Handle mouse out event on diff spans
        function handleDiffMouseOut(event) {
            const span = event.target;
            span.classList.remove('diff-hover');
        }

        // Handle click event on diff spans
        function handleDiffClick(event) {
            const span = event.target;
            const diffIndex = parseInt(span.getAttribute('data-diff-index'));
            
            // Check if diffIndex is a valid number and within the bounds of globalDiffInfo
            if (!isNaN(diffIndex) && diffIndex >= 0 && diffIndex < globalDiffInfo.length) {
                const diffInfo = globalDiffInfo[diffIndex];
                showDiffPopup(event.clientX, event.clientY, diffInfo, diffIndex);
            } else {
                console.error('Invalid diff index:', diffIndex);
                // Optionally, show an error message to the user
                alert('An error occurred while processing the diff. Please try again.');
            }
        }

        // Function to show the diff popup
        function showDiffPopup(x, y, diffInfo, diffIndex) {
            const popup = document.getElementById('diffPopup');
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;
            popup.style.display = 'block';

            // Check if diffInfo is defined and has the expected properties
            if (diffInfo && typeof diffInfo === 'object') {
                // Set the diff texts
                document.getElementById('diffOriginalText').textContent = diffInfo.originalDiffString || '[No Text]';
                document.getElementById('diffRewrittenText').textContent = diffInfo.rewrittenDiffString || '[No Text]';

                // Store the diffIndex in the popup element
                popup.setAttribute('data-diff-index', diffIndex);
            } else {
                // Handle the case where diffInfo is undefined or not as expected
                document.getElementById('diffOriginalText').textContent = '[Error: No diff information available]';
                document.getElementById('diffRewrittenText').textContent = '[Error: No diff information available]';
                console.error('Invalid diffInfo object:', diffInfo);
            }
        }

        // Hide the popup when clicking outside
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('diffPopup');
            if (popup.style.display === 'block' && !popup.contains(event.target) && !event.target.matches('.removed, .added')) {
                popup.style.display = 'none';
            }
        });

        // Event listeners for the popup buttons
        document.getElementById('acceptChangeBtn').addEventListener('click', function() {
            handleDiffSelection('accept');
        });

        document.getElementById('keepOriginalBtn').addEventListener('click', function() {
            handleDiffSelection('reject');
        });

        // Close button functionality
        document.querySelector('#diffPopup .close-btn').addEventListener('click', closeDiffPopup);

        // Handle the diff selection
        function handleDiffSelection(action) {
            const popup = document.getElementById('diffPopup');
            const diffIndex = parseInt(popup.getAttribute('data-diff-index'));
            const diffInfo = globalDiffInfo[diffIndex];

            // Hide the popup
            popup.style.display = 'none';

            if (action === 'accept') {
                // Keep the rewritten version for this diff
                console.log('originalPairwise', originalPairwise);
                console.log('originalPairwise.substring(0, diffInfo.originalSpanStart)', originalPairwise.substring(0, diffInfo.originalSpanStart));
                console.log('diffInfo.rewrittenDiffString', diffInfo.rewrittenDiffString);
                console.log('originalPairwise.substring(diffInfo.originalSpanEnd)', originalPairwise.substring(diffInfo.originalSpanEnd));
                originalPairwise = originalPairwise.substring(0, diffInfo.originalSpanStart) +
                    diffInfo.rewrittenDiffString +
                    originalPairwise.substring(diffInfo.originalSpanEnd);
            } else if (action === 'reject') {
                // Keep the original version for this diff
                console.log('rewrittenPairwise', rewrittenPairwise);
                console.log('rewrittenPairwise.substring(0, diffInfo.rewrittenSpanStart)', rewrittenPairwise.substring(0, diffInfo.rewrittenSpanStart));
                console.log('diffInfo.originalDiffString', diffInfo.originalDiffString);
                console.log('rewrittenPairwise.substring(diffInfo.rewrittenSpanEnd)', rewrittenPairwise.substring(diffInfo.rewrittenSpanEnd));
                rewrittenPairwise = rewrittenPairwise.substring(0, diffInfo.rewrittenSpanStart) +
                    diffInfo.originalDiffString +
                    rewrittenPairwise.substring(diffInfo.rewrittenSpanEnd);
            }

            // Update the diff view
            updateDiffView(originalPairwise, rewrittenPairwise);
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modify the callGPTandCompareDiff function to initialize the global variables
        async function callGPTandCompareDiff() {
            const text1 = document.getElementById('text1').value;
            const context = document.getElementById('context').value;

            // Strip whitespace from each line
            const strippedText = stripLinesAndRejoin(text1);

            // Call ChatGPT API to get rewritten text
            rawRewrittenText = await callChatGPT(strippedText, context);
            const rewrittenText = stripLinesAndRejoin(rawRewrittenText);

            // Initialize global variables
            originalPairwise = strippedText;
            rewrittenPairwise = rewrittenText;

            // Update the diff view
            updateDiffView(originalPairwise, rewrittenPairwise);
        }

        function copyAdditions() {
            const additionsText = document.getElementById('additions').innerText;
            navigator.clipboard.writeText(additionsText).then(() => {
                const alert = document.getElementById('copyAlert');
                alert.style.display = 'block';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }

        function toggleApiKeyInput() {
            const apiKeyPopup = document.getElementById('apiKeyPopup');
            apiKeyPopup.style.display = (apiKeyPopup.style.display === 'none' || apiKeyPopup.style.display === '') ? 'block' : 'none';
        }

        function saveApiKey() {
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput.value.trim() !== '') {
                toggleApiKeyInput();
                alert('API Key saved successfully!');
            } else {
                alert('Please enter an API Key before saving.');
            }
        }

        // Add event listeners
        document.getElementById('keepLatexCheck').addEventListener('change', updateNotes);
        document.getElementById('sameWordStartCheck').addEventListener('change', updateNotes);
        document.getElementById('sameWordStart').addEventListener('input', updateNotes);
        document.getElementById('userNotes').addEventListener('input', updateNotes);

        // Initial update
        updateNotes();

        document.addEventListener('keydown', function(event) {
            if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('proofreadBtn').click();
            }
        });

        // Add this new function
        function toggleOptions() {
            const optionsContainer = document.getElementById('optionsContainer');
            const toggleBtn = document.getElementById('toggleOptionsBtn');
            
            if (optionsContainer.classList.contains('show')) {
                optionsContainer.classList.remove('show');
                toggleBtn.textContent = 'Show Options';
                
                // Set max-height to 0 after a short delay to allow the transition to complete
                setTimeout(() => {
                    optionsContainer.style.maxHeight = '0';
                }, 50);
            } else {
                optionsContainer.classList.add('show');
                toggleBtn.textContent = 'Hide Options';
                
                // Set max-height to a large value to accommodate the content
                optionsContainer.style.maxHeight = optionsContainer.scrollHeight + 'px';
            }
        }

        // Add this new function
        function closeDiffPopup() {
            document.getElementById('diffPopup').style.display = 'none';
        }
    </script>
</body>
</html>